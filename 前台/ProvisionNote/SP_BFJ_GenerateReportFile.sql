/*
create time:2014/9/15
creator:dongx
content:生成备付金报表文件数据 
*/

CREATE OR REPLACE PROCEDURE SP_BFJ_GenerateReportFile
(
	p_tradeDate	char,    		-- 日期 格式YYYYMMDD 
	p_bankName  char,			-- 银行名称 如 SZYH，汇总表格传NULL
	p_tableName char,           -- 表名 如 T1_1 T1_2
	p_cursor out SYS_REFCURSOR
)
as
    v_now            date := sysdate;  --当前时间
	v_tradeID	     char(16);		   --序列 
	v_tradeMoney     int; 
	v_ex             exception;
BEGIN
	IF  p_tableName = 'T1_1' THEN   --表1 ,有分表
		IF  p_bankName IS NOT NULL THEN
			OPEN p_cursor FOR
			SELECT C1 A01,C2 A02,C3 A03,C4 A04,C5 A05,C6 A06,C7 A07,C8 A08,C9 A09,C10 A10,C11 A11,C12 A12,C13 A13,C14 A14
			FROM TF_F_BFJ_REPORT1
			WHERE BFJDATE = p_tradeDate
			AND BANKCODE = p_bankName;
		ELSE
			OPEN p_cursor FOR
			SELECT SUM(NVL(C1,0)) A01,SUM(NVL(C2,0)) A02,SUM(NVL(C3,0)) A03,SUM(NVL(C4,0)) A04,SUM(NVL(C5,0)) A05,SUM(NVL(C6,0)) A06,SUM(NVL(C7,0)) A07,
			SUM(NVL(C8,0)) A08,SUM(NVL(C9,0)) A09,SUM(NVL(C10,0)) A10,SUM(NVL(C11,0)) A11,SUM(NVL(C12,0)) A12,SUM(NVL(C13,0)) A13,SUM(NVL(C14,0)) A14
			FROM TF_F_BFJ_REPORT1
			WHERE BFJDATE = p_tradeDate;
		END IF;
	ELSIF p_tableName = 'T1_2' THEN   --表2 ，无分表 
		OPEN p_cursor FOR
		SELECT (T5C3 - C7) B01,(T5C3 - C7 - C3) B02,C3 B03,T3C4 B04,C5 B05,C6 B06,C7 B07,C8 B08,C9 B09 
		FROM TF_F_BFJ_REPORT2 T2
		INNER JOIN (SELECT SUM(NVL(C4,0)) T3C4,BFJDATE FROM TF_F_BFJ_REPORT3 WHERE  BFJDATE = p_tradeDate ) T3 ON T2.BFJDATE = T3.BFJDATE
		INNER JOIN (SELECT SUM(NVL(C3,0)) T5C3,BFJDATE FROM TF_F_BFJ_REPORT5 WHERE  BFJDATE = p_tradeDate ) T5 ON T2.BFJDATE = T5.BFJDATE
		WHERE BFJDATE = p_tradeDate;
	ELSIF p_tableName = 'T1_3' THEN 	 --表3 ，无分表  
		OPEN p_cursor FOR
		SELECT C1 C01,C2 C02,C3 C03,C4 C04
		FROM TF_F_BFJ_REPORT3 T3
 		WHERE BFJDATE = p_tradeDate ;
	ELSIF p_tableName = 'T1_4' THEN 	 --表4 ，无分表  
		OPEN p_cursor FOR
		SELECT C1 D01,C2 D02,C3 D03 
		FROM TF_F_BFJ_REPORT4  
 		WHERE BFJDATE = p_tradeDate ;
	ELSIF  p_tableName = 'T1_5' THEN   --表5 ,无分表 
		OPEN p_cursor FOR
		SELECT T5.C1 E01,T5.C2 E02,T5.C3 E03,T4.C1 E04,T4.C2 E05,(T5.C1 + T5.C2 - T5.C3 + T4.C2 - T4.C1) E06
		FROM TF_F_BFJ_REPORT5  T5
		INNER JOIN TF_F_BFJ_REPORT4 T4 ON T4.BFJDATE = T5.BFJDATE
		WHERE T5.BFJDATE = p_tradeDate; 
	ELSIF  p_tableName = 'T1_6' THEN	--表6 ,有分表 
		IF  p_bankName IS NOT NULL THEN
			OPEN p_cursor FOR
			SELECT C2 F01,C3 F02,C4 F03,C5 F04,C6 F05,C7 F06,C8 F07,C10 F08,C11 F09,
			(C2 + C3 + C4 + C5 + C6 + C7 + C8 + C10 + C11) F10,
			C14 G01,C15 G02,C16 G03,C17 G04,C18 G05, C19 G06, C20 G07, C21 G08, C22 G09, C23 G10, C25 G11, C26 G12, C27 G13, 
			(C14 + C15 + C16 + C17 + C18 + C19 + C20 + C21 + C22 + C23 + C25 + C26 + C27) G14
			FROM TF_F_BFJ_REPORT6
			WHERE BFJDATE = p_tradeDate
			AND BANKCODE = p_bankName;
		ELSE
			OPEN p_cursor FOR
			SELECT SUM(NVL(C2,0)) F01,SUM(NVL(C3,0)) F02,SUM(NVL(C4,0)) F03,SUM(NVL(C5,0)) F04,SUM(NVL(C6,0)) F05,
			SUM(NVL(C7,0)) F06,SUM(NVL(C8,0)) F07,SUM(NVL(C10,0)) F08,SUM(NVL(C11,0)) F09,
			(SUM(NVL(C2,0)) + SUM(NVL(C3,0)) + SUM(NVL(C4,0)) + SUM(NVL(C5,0)) + SUM(NVL(C6,0)) + SUM(NVL(C7,0)) + SUM(NVL(C8,0)) + SUM(NVL(C10,0)) + SUM(NVL(C11,0))) F10,
			SUM(NVL(C14,0)) G01,SUM(NVL(C15,0)) G02,SUM(NVL(C16,0)) G03,SUM(NVL(C17,0)) G04,SUM(NVL(C18,0)) G05, SUM(NVL(C19,0)) G06, SUM(NVL(C20,0)) G07, 
			SUM(NVL(C21,0)) G08, SUM(NVL(C22,0)) G09, SUM(NVL(C23,0)) G10, SUM(NVL(C25,0)) G11, SUM(NVL(C26,0)) G12, SUM(NVL(C27,0)) G13, 
			(SUM(NVL(C14,0)) + SUM(NVL(C15,0)) + SUM(NVL(C16,0)) + SUM(NVL(C17,0)) + SUM(NVL(C18,0)) + SUM(NVL(C19,0)) + SUM(NVL(C20,0)) + SUM(NVL(C21,0)) 
			+ SUM(NVL(C22,0)) + SUM(NVL(C23,0)) + SUM(NVL(C25,0)) + SUM(NVL(C26,0)) + SUM(NVL(C27,0))) G14
			FROM TF_F_BFJ_REPORT6
			WHERE BFJDATE = p_tradeDate;
		END IF;
	ELSIF  p_tableName = 'T1_7' THEN	--表7 ,无分表 
		OPEN p_cursor FOR
		SELECT C1 H01,C2 H02,C3 H03, (C1 + C2 - C3) H04
		FROM TF_F_BFJ_REPORT7  T7 
		WHERE BFJDATE = p_tradeDate; 
	ELSIF p_tableName = 'T1_8' THEN	--表8 ,无分表 
		OPEN p_cursor FOR
		SELECT C1 I01,C2 I02,C3 I03, C4 I04
		FROM TF_F_BFJ_REPORT8  T8
		WHERE BFJDATE = p_tradeDate; 
	ELSIF p_tableName = 'T1_9' THEN	--表9 ,有分表 
		IF  p_bankName IS NOT NULL THEN
			OPEN p_cursor FOR
			SELECT C1 J01,C2 J02,C3 J03,C4 J04 
			FROM TF_F_BFJ_REPORT9
			WHERE BFJDATE = p_tradeDate
			AND BANKCODE = p_bankName;
		ELSE
			OPEN p_cursor FOR
			SELECT SUM(NVL(C1,0)) J01,SUM(NVL(C2,0)) J02,SUM(NVL(C3,0)) J03,SUM(NVL(C4,0)) J04 
			FROM TF_F_BFJ_REPORT9
			WHERE BFJDATE = p_tradeDate;
		END IF;	
	ELSIF p_tableName = 'T1_10' THEN	--表10 ,有分表 
		IF  p_bankName IS NOT NULL THEN
			OPEN p_cursor FOR
			SELECT C1 K01,C2 K02,C3 K03,C4 K04 ,C5 K05 ,C6 K06 ,C7 K07 ,C8 K08 ,C9 K09 ,C10 K10 ,
			C11 K11 ,C12 K12 ,C13 K13 ,C14 K14 ,C15 K15 ,C16 K16 ,C17 K17 ,C18 K18 ,C19 K19 ,C20 K20,
			C21 K21 ,C22 K22 ,C23 K23 ,C24 K24
			FROM TF_F_BFJ_REPORT10
			WHERE BFJDATE = p_tradeDate
			AND BANKCODE = p_bankName;
		ELSE
			OPEN p_cursor FOR
			SELECT SUM(NVL(C1,0)) K01,SUM(NVL(C2,0)) K02,SUM(NVL(C3,0)) K03,SUM(NVL(C4,0)) K04 ,SUM(NVL(C5,0)) K05 ,
			SUM(NVL(C6,0)) K06 ,SUM(NVL(C7,0)) K07 ,SUM(NVL(C8,0)) K08 ,SUM(NVL(C9,0)) K09 ,SUM(NVL(C10,0)) K10 ,
			SUM(NVL(C11,0)) K11 ,SUM(NVL(C12,0)) K12 ,SUM(NVL(C13,0)) K13 ,SUM(NVL(C14,0)) K14 ,SUM(NVL(C15,0)) K15 ,
			SUM(NVL(C16,0)) K16 ,SUM(NVL(C17,0)) K17 ,SUM(NVL(C18,0)) K18 ,SUM(NVL(C19,0)) K19 ,SUM(NVL(C20,0)) K20,
			SUM(NVL(C21,0)) K21 ,SUM(NVL(C22,0)) K22 ,SUM(NVL(C23,0)) K23 ,SUM(NVL(C24,0)) K24
			FROM TF_F_BFJ_REPORT10
			WHERE BFJDATE = p_tradeDate;
		END IF;	
	ELSIF p_tableName = 'T1_11' THEN	--表11 ,无分表
		OPEN p_cursor FOR
		SELECT T5.C1 L1,(T5.C1 + T5.C2 - T5.C3 + T4.C2 - T4.C1) L2,(T5.C1 + T5.C2 - T5.C3 + T4.C2 - T4.C1 - T5.C1) L3, T7.C2 L4,
		T7.C3 L5, (T8.C2 + T8.C1) L6, T8.C3 L7, T2.C3 L8, T9.C1 L9, T9.C2 L10, T9.C3 L11, T9.C4 L12, T6.F03 L13,T6.F06 L14,
		T6.G03 L15,T6.G06 L16, T6.G07 L17, T6.G08 L18, T6.G10 L19, 0 L20, 0 Z1, 
		((T5.C1 + T5.C2 - T5.C3 + T4.C2 - T4.C1) - T7.C2 + T7.C3 + (T8.C2 + T8.C1) - T8.C3 + T2.C3 - T9.C1 + T9.C2 + T9.C3 - T9.C4 
		+ T6.F03 + T6.F06 - T6.G03 - T6.G06 - T6.G07 - T6.G08 - T6.G10) L21 , 0 L22, 0 L23, 0 L24
		FROM TF_F_BFJ_REPORT5 T5  
		INNER JOIN TF_F_BFJ_REPORT4 T4 ON T4.BFJDATE = T5.BFJDATE
		INNER JOIN TF_F_BFJ_REPORT7 T7 ON T5.BFJDATE = T7.BFJDATE
		INNER JOIN TF_F_BFJ_REPORT8 T8 ON T5.BFJDATE = T8.BFJDATE
		INNER JOIN TF_F_BFJ_REPORT2 T2 ON T5.BFJDATE = T2.BFJDATE
		INNER JOIN (SELECT  BFJDATE, SUM(NVL(C1,0)) C1, SUM(NVL(C2,0)) C2, SUM(NVL(C3,0)) C3, SUM(NVL(C4,0)) C4 
		FROM TF_F_BFJ_REPORT9 WHERE BFJDATE = p_tradeDate) T9 ON T5.BFJDATE = T9.BFJDATE
		INNER JOIN (SELECT  SUM(NVL(C4,0)) F03  ,SUM(NVL(C7,0)) F06, SUM(NVL(C16,0)) G03, SUM(NVL(C19,0)) G06, SUM(NVL(C20,0)) G07, 
			SUM(NVL(C21,0)) G08,  SUM(NVL(C23,0)) G10, SUM(NVL(C25,0)) G11 ,BFJDATE
			FROM TF_F_BFJ_REPORT6
			WHERE BFJDATE = p_tradeDate) T6 ON T5.BFJDATE = T6.BFJDATE
		WHERE T5.BFJDATE = p_tradeDate; 
	ELSIF p_tableName = 'T1_12' THEN
		OPEN p_cursor FOR
		SELECT L23 M1,(L13 - L16 + L17) M2, (L14 + L19) M3, (L8 - L18) M4, (L4 - L5) M5, (L6 - L7) M6,
		L9 M7, L10 M8, L11 M9, L12 M10, (0 - L15) M11 , 0 Z2, (L23 - (L13 - L16 + L17) - (L14 + L19) - (L8 - L18) + (L4 - L5) - (L6 - L7)
		+ L9 - (0 - L15)) M12, L2 M13, (L2 - (L23 - (L13 - L16 + L17) - (L14 + L19) - (L8 - L18) + (L4 - L5) - (L6 - L7)
		+ L9 - (0 - L15))) M14 
		FROM (
			SELECT T5.C1 L1,(T5.C1 + T5.C2 - T5.C3 + T4.C2 - T4.C1) L2,(T5.C1 + T5.C2 - T5.C3 + T4.C2 - T4.C1 - T5.C1) L3, T7.C2 L4,
			T7.C3 L5, (T8.C2 + T8.C1) L6, T8.C3 L7, T2.C3 L8, T9.C1 L9, T9.C2 L10, T9.C3 L11, T9.C4 L12, T6.F03 L13,T6.F06 L14,
			T6.G03 L15,T6.G06 L16, T6.G07 L17, T6.G08 L18, T6.G10 L19, 0 L20, 0 Z1, 
			((T5.C1 + T5.C2 - T5.C3 + T4.C2 - T4.C1) - T7.C2 + T7.C3 + (T8.C2 + T8.C1) - T8.C3 + T2.C3 - T9.C1 + T9.C2 + T9.C3 - T9.C4 
			+ T6.F03 + T6.F06 - T6.G03 - T6.G06 - T6.G07 - T6.G08 - T6.G10) L21 , 0 L22, 0 L23, 0 L24
			FROM TF_F_BFJ_REPORT5 T5  
			INNER JOIN TF_F_BFJ_REPORT4 T4 ON T4.BFJDATE = T5.BFJDATE
			INNER JOIN TF_F_BFJ_REPORT7 T7 ON T5.BFJDATE = T7.BFJDATE
			INNER JOIN TF_F_BFJ_REPORT8 T8 ON T5.BFJDATE = T8.BFJDATE
			INNER JOIN TF_F_BFJ_REPORT2 T2 ON T5.BFJDATE = T2.BFJDATE
			INNER JOIN (SELECT  BFJDATE, SUM(NVL(C1,0)) C1, SUM(NVL(C2,0)) C2, SUM(NVL(C3,0)) C3, SUM(NVL(C4,0)) C4 
			FROM TF_F_BFJ_REPORT9 WHERE BFJDATE = p_tradeDate) T9 ON T5.BFJDATE = T9.BFJDATE
			INNER JOIN (SELECT  SUM(NVL(C4,0)) F03  ,SUM(NVL(C7,0)) F06, SUM(NVL(C16,0)) G03, SUM(NVL(C19,0)) G06, SUM(NVL(C20,0)) G07, 
				SUM(NVL(C21,0)) G08,  SUM(NVL(C23,0)) G10, SUM(NVL(C25,0)) G11 ,BFJDATE
				FROM TF_F_BFJ_REPORT6
				WHERE BFJDATE = p_tradeDate) T6 ON T5.BFJDATE = T6.BFJDATE
			WHERE T5.BFJDATE = p_tradeDate); 
	ELSIF p_tableName = 'T1_13' THEN
		OPEN p_cursor FOR
		SELECT C1 N1, C2 N2, C3 N3, C4 N4, C5 N5, C6 N6
		FROM TF_F_BFJ_REPORT13
		WHERE BFJDATE = p_tradeDate;
	END IF; 
    RETURN;  
end;
/
show errors